# Alias for quicker typing

sync() {
    if [[ -z "$1" ]] || [[ -z "$2" ]]; then
        echo "Usage: sync <entity_type> <id> [id2 id3 ...]"
        echo "Example: sync deal_person 186090"
        return 1
    fi

    local entity_type=$1
    shift  # Remove first arg, leaving just the IDs
    local ids=("$@")

    # 1. Format IDs as JSON array
    local ids_json
    ids_json=$(printf '"%s",' "${ids[@]}")
    ids_json=${ids_json%,}

    # 2. Build the JSON for the QUEUE command (which supports the filter)
    local filter="{\"id\": [$ids_json]}"

    echo "Step 1: Queuing specific IDs for $entity_type..."
    # We use the filter here because 'queue-unsynced' supports it
    docker compose exec -it web bin/console search:synchronisation:queue-unsynced \
        --entity-type="$entity_type" \
        --query-filter="$filter"

    echo "Step 2: Indexing queued IDs..."
    # We DON'T use the filter here because the command doesn't support it
    # It will pick up what Step 1 just put in the table.
    docker compose exec -it web bin/console search:synchronisation:index-unsynced \
        --entity-type="$entity_type"
}



dump() {
    if [[ -z "$1" ]] || [[ -z "$2" ]]; then
        echo "Usage: dump <entity_type> <id>"
        echo "Example: dump deal_firm 186090"
        return 1
    fi

    local entity_type=$1
    local entity_id=$2

    # Zsh Magic: Split by '_', Capitalize words, Join them back
    # deal_person -> DealPerson
    # 1. (s:_:) splits by underscore
    # 2. (C) Capitalizes each word
    # 3. (j::) joins them with absolutely nothing (removes the spaces)
    local folder_name="${(j::)${(C)${(s:_:)entity_type}}// /}"

    local dump_folder="/app/tests/Unit/Service/Synchronisation/DocumentDataProvider/DataMapper/${folder_name}/__api_responses__"

    mkdir -p "$dump_folder"
    echo "Dumping $entity_type (ID: $entity_id) to $folder_name..."

    docker compose exec -it web bin/console e:res:dump \
        -t "$entity_type" \
        -f "{\"id\":\"$entity_id\"}" \
        --dump-folder="$dump_folder"
}

