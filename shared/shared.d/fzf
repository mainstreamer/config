#!/bin/sh
# fzf: key-bindings, completion, and custom helpers
# Shortcuts: Ctrl+T (file search), Ctrl+R (history), Alt+C / Esc+C (cd into dir)

command -v fzf &>/dev/null || return 0

# Appearance: bottom panel with border, nord-inspired colors
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --inline-info \
--color=fg:#d8dee9,bg:#2e3440,hl:#88c0d0 \
--color=fg+:#eceff4,bg+:#3b4252,hl+:#5e81ac \
--color=info:#ebcb8b,prompt:#81a1c1,pointer:#bf616a \
--color=marker:#a3be8c,spinner:#b48ead,header:#88c0d0"

# Use fd for file search if available (respects .gitignore)
if command -v fd &>/dev/null; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
fi

# Preview: bat for files, eza/ls for directories
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:300 {} 2>/dev/null || head -300 {}'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --icons --level=1 {} 2>/dev/null || ls {}'"

# Ctrl+R preview: show full command
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window=up:3:wrap"

# Source key-bindings and completion for the current shell
_fzf_source() {
    local f="$1"
    [ -f "$f" ] && . "$f"
}

# Detect shell type
case "${SHELL_TYPE:-${SHELL##*/}}" in
    bash)
        # Linuxbrew
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.bash"
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.bash"
        # Homebrew (macOS)
        _fzf_source "/opt/homebrew/opt/fzf/shell/key-bindings.bash"
        _fzf_source "/opt/homebrew/opt/fzf/shell/completion.bash"
        # System package (Fedora, Arch, etc.)
        _fzf_source "/usr/share/fzf/shell/key-bindings.bash"
        _fzf_source "/usr/share/fzf/key-bindings.bash"
        # Debian/Ubuntu
        _fzf_source "/usr/share/doc/fzf/examples/key-bindings.bash"
        _fzf_source "/usr/share/bash-completion/completions/fzf"
        ;;
    zsh)
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.zsh"
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.zsh"
        _fzf_source "/opt/homebrew/opt/fzf/shell/key-bindings.zsh"
        _fzf_source "/opt/homebrew/opt/fzf/shell/completion.zsh"
        _fzf_source "/usr/share/fzf/shell/key-bindings.zsh"
        _fzf_source "/usr/share/fzf/key-bindings.zsh"
        _fzf_source "/usr/share/doc/fzf/examples/key-bindings.zsh"
        ;;
esac

unset -f _fzf_source

# macOS fix: Alt+C sends 'รง' instead of escape sequence.
# Bind Esc+C as portable alternative (press Esc, then C).
# For native Alt+C: iTerm2 -> Profiles -> Keys -> Left Option -> Esc+
if [ "$(uname -s)" = "Darwin" ]; then
    case "${SHELL_TYPE:-${SHELL##*/}}" in
        bash)
            if type __fzf_cd__ &>/dev/null; then
                bind '"\ec": " \C-b\C-k \C-u`__fzf_cd__`\e\C-e\er\C-m\C-y\C-h\e \C-y\ey\C-x\C-x\C-d"' 2>/dev/null
            fi
            ;;
        zsh)
            if type fzf-cd-widget &>/dev/null; then
                bindkey '\ec' fzf-cd-widget 2>/dev/null
            fi
            ;;
    esac
fi
