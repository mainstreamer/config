#!/bin/sh
# fzf: key-bindings, completion, and custom helpers
# Shortcuts: Ctrl+T (file paste), Ctrl+R (history), Alt+C (cd), Alt+O (open file)
# macOS: Option+C/O work too (sends ç/ø); Esc+c / Esc+o as universal fallback

command -v fzf &>/dev/null || return 0

# Appearance: bottom panel with border, nord-inspired colors
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --inline-info \
--color=fg:#d8dee9,bg:#2e3440,hl:#88c0d0 \
--color=fg+:#eceff4,bg+:#3b4252,hl+:#5e81ac \
--color=info:#ebcb8b,prompt:#81a1c1,pointer:#bf616a \
--color=marker:#a3be8c,spinner:#b48ead,header:#88c0d0"

# Use fd for file search if available (respects .gitignore)
if command -v fd &>/dev/null; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
fi

# Preview: bat for files, eza/ls for directories
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:300 {} 2>/dev/null || head -300 {}'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --icons --level=1 {} 2>/dev/null || ls {}'"

# Ctrl+R preview: show full command
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window=up:3:wrap"

# Source key-bindings and completion
# fzf 0.48+ supports --bash/--zsh (single clean integration), older needs manual sourcing
case "${SHELL_TYPE:-${SHELL##*/}}" in
    bash)
        if fzf --bash &>/dev/null; then
            eval "$(fzf --bash)"
        else
            _fzf_try() { [ -f "$1" ] && . "$1"; }
            # Try paths in priority order, stop after first hit for each type
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.bash \
                     /opt/homebrew/opt/fzf/shell/key-bindings.bash \
                     /usr/share/fzf/shell/key-bindings.bash \
                     /usr/share/fzf/key-bindings.bash \
                     /usr/share/doc/fzf/examples/key-bindings.bash; do
                [ -f "$f" ] && . "$f" && break
            done
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.bash \
                     /opt/homebrew/opt/fzf/shell/completion.bash \
                     /usr/share/bash-completion/completions/fzf; do
                [ -f "$f" ] && . "$f" && break
            done
            unset f _fzf_try
        fi
        ;;
    zsh)
        if fzf --zsh &>/dev/null; then
            eval "$(fzf --zsh)"
        else
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.zsh \
                     /opt/homebrew/opt/fzf/shell/key-bindings.zsh \
                     /usr/share/fzf/shell/key-bindings.zsh \
                     /usr/share/fzf/key-bindings.zsh \
                     /usr/share/doc/fzf/examples/key-bindings.zsh; do
                [ -f "$f" ] && . "$f" && break
            done
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.zsh \
                     /opt/homebrew/opt/fzf/shell/completion.zsh; do
                [ -f "$f" ] && . "$f" && break
            done
            unset f
        fi
        ;;
esac

# Custom keybindings: Alt+C (cd into dir), Alt+O (open file in editor/preview)
case "${SHELL_TYPE:-${SHELL##*/}}" in
    bash)
        # Alt+C: fuzzy cd — places "cd <dir>" on command line, Enter to execute
        __fzf_cd_clean__() {
            local cmd dir
            cmd="${FZF_ALT_C_COMMAND:-"command find -L . -mindepth 1 \\( -path '*/\\.*' \\) -prune -o -type d -print 2>/dev/null | command cut -b3-"}"
            dir=$(eval "$cmd" | FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS $FZF_ALT_C_OPTS" fzf +m)
            if [[ -n "$dir" ]]; then
                READLINE_LINE="cd -- ${dir@Q}"
                READLINE_POINT=${#READLINE_LINE}
            fi
        }
        bind -x '"\ec": __fzf_cd_clean__'
        # macOS: Option+C sends 'ç' instead of \ec
        [[ "$(uname -s)" == "Darwin" ]] && bind -x '"ç": __fzf_cd_clean__'

        # Alt+O: fuzzy open file — Enter=edit in $EDITOR, Alt+Enter=preview
        __fzf_open_file__() {
            local cmd out key file
            cmd="${FZF_DEFAULT_COMMAND:-"command find -L . -mindepth 1 -type f -not -path '*/\.*' 2>/dev/null"}"
            out=$(eval "$cmd" | FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS" fzf \
                --preview 'bat --color=always --style=numbers --line-range=:300 {} 2>/dev/null || xxd {} | head -300' \
                --expect=alt-enter \
                --header='Enter=edit | Alt+Enter=preview')
            key=$(head -1 <<< "$out")
            file=$(sed -n '2p' <<< "$out")
            [[ -z "$file" ]] && return
            if [[ "$key" == "alt-enter" ]]; then
                if file --brief --mime-type "$file" 2>/dev/null | grep -q '^text/\|json\|xml\|javascript\|empty'; then
                    bat --paging=always --style=numbers "$file" 2>/dev/null || less "$file"
                else
                    xxd "$file" | less
                fi
            else
                nvim "$file"
            fi
        }
        bind -x '"\eo": __fzf_open_file__'
        # macOS: Option+O sends 'ø' instead of \eo
        [[ "$(uname -s)" == "Darwin" ]] && bind -x '"ø": __fzf_open_file__'
        ;;
    zsh)
        # Alt+C: fuzzy cd — places "cd <dir>" on command line, Enter to execute
        fzf-cd-clean-widget() {
            local cmd dir
            cmd="${FZF_ALT_C_COMMAND:-"command find -L . -mindepth 1 \\( -path '*/\\.*' \\) -prune -o -type d -print 2>/dev/null | command cut -b3-"}"
            dir=$(eval "$cmd" | FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS $FZF_ALT_C_OPTS" fzf +m)
            if [[ -n "$dir" ]]; then
                BUFFER="cd -- ${(q)dir}"
                CURSOR=${#BUFFER}
            fi
            zle reset-prompt
        }
        zle -N fzf-cd-clean-widget
        bindkey '\ec' fzf-cd-clean-widget
        # macOS: Alt+C sends 'ç'
        [[ "$(uname -s)" == "Darwin" ]] && bindkey 'ç' fzf-cd-clean-widget 2>/dev/null

        # Alt+O: fuzzy open file — Enter=edit in $EDITOR, Alt+Enter=preview
        fzf-open-file-widget() {
            local cmd out key file
            cmd="${FZF_DEFAULT_COMMAND:-"command find -L . -mindepth 1 -type f -not -path '*/\.*' 2>/dev/null"}"
            out=$(eval "$cmd" | FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS" fzf \
                --preview 'bat --color=always --style=numbers --line-range=:300 {} 2>/dev/null || xxd {} | head -300' \
                --expect=alt-enter \
                --header='Enter=edit | Alt+Enter=preview')
            key=$(head -1 <<< "$out")
            file=$(sed -n '2p' <<< "$out")
            if [[ -n "$file" ]]; then
                if [[ "$key" == "alt-enter" ]]; then
                    if file --brief --mime-type "$file" 2>/dev/null | grep -q '^text/\|json\|xml\|javascript\|empty'; then
                        bat --paging=always --style=numbers "$file" 2>/dev/null || less "$file"
                    else
                        xxd "$file" | less
                    fi
                else
                    nvim "$file"
                fi
            fi
            zle reset-prompt
        }
        zle -N fzf-open-file-widget
        bindkey '\eo' fzf-open-file-widget
        # macOS: Option+O sends 'ø'
        [[ "$(uname -s)" == "Darwin" ]] && bindkey 'ø' fzf-open-file-widget 2>/dev/null
        ;;
esac
