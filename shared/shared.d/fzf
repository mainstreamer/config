#!/bin/sh
# fzf: key-bindings, completion, and custom helpers
# Shortcuts: Ctrl+T (file search), Ctrl+R (history), Alt+C / Esc+C (cd into dir)

command -v fzf &>/dev/null || return 0

# Appearance: bottom panel with border, nord-inspired colors
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --inline-info \
--color=fg:#d8dee9,bg:#2e3440,hl:#88c0d0 \
--color=fg+:#eceff4,bg+:#3b4252,hl+:#5e81ac \
--color=info:#ebcb8b,prompt:#81a1c1,pointer:#bf616a \
--color=marker:#a3be8c,spinner:#b48ead,header:#88c0d0"

# Use fd for file search if available (respects .gitignore)
if command -v fd &>/dev/null; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
fi

# Preview: bat for files, eza/ls for directories
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:300 {} 2>/dev/null || head -300 {}'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --icons --level=1 {} 2>/dev/null || ls {}'"

# Ctrl+R preview: show full command
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window=up:3:wrap"

# Source key-bindings and completion
# fzf 0.48+ supports --bash/--zsh (single clean integration), older needs manual sourcing
case "${SHELL_TYPE:-${SHELL##*/}}" in
    bash)
        if fzf --bash &>/dev/null; then
            eval "$(fzf --bash)"
        else
            _fzf_try() { [ -f "$1" ] && . "$1"; }
            # Try paths in priority order, stop after first hit for each type
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.bash \
                     /opt/homebrew/opt/fzf/shell/key-bindings.bash \
                     /usr/share/fzf/shell/key-bindings.bash \
                     /usr/share/fzf/key-bindings.bash \
                     /usr/share/doc/fzf/examples/key-bindings.bash; do
                [ -f "$f" ] && . "$f" && break
            done
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.bash \
                     /opt/homebrew/opt/fzf/shell/completion.bash \
                     /usr/share/bash-completion/completions/fzf; do
                [ -f "$f" ] && . "$f" && break
            done
            unset f _fzf_try
        fi
        ;;
    zsh)
        if fzf --zsh &>/dev/null; then
            eval "$(fzf --zsh)"
        else
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.zsh \
                     /opt/homebrew/opt/fzf/shell/key-bindings.zsh \
                     /usr/share/fzf/shell/key-bindings.zsh \
                     /usr/share/fzf/key-bindings.zsh \
                     /usr/share/doc/fzf/examples/key-bindings.zsh; do
                [ -f "$f" ] && . "$f" && break
            done
            for f in /home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.zsh \
                     /opt/homebrew/opt/fzf/shell/completion.zsh; do
                [ -f "$f" ] && . "$f" && break
            done
            unset f
        fi
        ;;
esac

# Override Alt+C with bind -x to avoid __fzf_cd__ text flashing on command line
# Also fixes macOS where Alt+C sends 'ç' (Esc+C works as fallback)
case "${SHELL_TYPE:-${SHELL##*/}}" in
    bash)
        if type __fzf_cd__ &>/dev/null; then
            __fzf_cd_clean__() {
                local dir
                dir=$(__fzf_cd__ 2>/dev/null)
                if [ -n "$dir" ]; then
                    eval "$dir"
                fi
            }
            bind -x '"\ec": __fzf_cd_clean__'
        fi
        ;;
    zsh)
        # zsh uses proper widgets — no fix needed on Linux
        # macOS: Alt+C sends 'ç', rebind Esc+C
        if [ "$(uname -s)" = "Darwin" ] && type fzf-cd-widget &>/dev/null; then
            bindkey '\ec' fzf-cd-widget 2>/dev/null
        fi
        ;;
esac
