#!/bin/sh
# fzf: key-bindings (Ctrl+R history, Alt+C directory jump) and completion

command -v fzf &>/dev/null || return 0

# Appearance: bottom panel with border
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --inline-info"

# Use fd for file search if available (respects .gitignore)
if command -v fd &>/dev/null; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
fi

# Preview: bat for files, eza/ls for directories
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:300 {} 2>/dev/null || head -300 {}'"
export FZF_ALT_C_OPTS="--preview 'eza --tree --icons --level=1 {} 2>/dev/null || ls {}'"

# Ctrl+R preview: show full command
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window=up:3:wrap"

# Source key-bindings and completion for the current shell
_fzf_source() {
    local f="$1"
    [ -f "$f" ] && . "$f"
}

# Detect shell type
case "${SHELL_TYPE:-${SHELL##*/}}" in
    bash)
        # Linuxbrew
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.bash"
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.bash"
        # Homebrew (macOS)
        _fzf_source "/opt/homebrew/opt/fzf/shell/key-bindings.bash"
        _fzf_source "/opt/homebrew/opt/fzf/shell/completion.bash"
        # System package (Fedora, Arch, etc.)
        _fzf_source "/usr/share/fzf/shell/key-bindings.bash"
        _fzf_source "/usr/share/fzf/key-bindings.bash"
        # Debian/Ubuntu
        _fzf_source "/usr/share/doc/fzf/examples/key-bindings.bash"
        _fzf_source "/usr/share/bash-completion/completions/fzf"
        ;;
    zsh)
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/key-bindings.zsh"
        _fzf_source "/home/linuxbrew/.linuxbrew/opt/fzf/shell/completion.zsh"
        _fzf_source "/opt/homebrew/opt/fzf/shell/key-bindings.zsh"
        _fzf_source "/opt/homebrew/opt/fzf/shell/completion.zsh"
        _fzf_source "/usr/share/fzf/shell/key-bindings.zsh"
        _fzf_source "/usr/share/fzf/key-bindings.zsh"
        _fzf_source "/usr/share/doc/fzf/examples/key-bindings.zsh"
        ;;
esac

unset -f _fzf_source
