#!/bin/sh
# Cross-platform aliases (works in bash and zsh)

# Modern CLI replacements
command -v bat &>/dev/null && alias cat='bat --paging=never'
command -v zoxide &>/dev/null && eval "$(zoxide init ${SHELL_TYPE:-bash})"

# eza: modern ls replacement with nord-inspired colors
if command -v eza &>/dev/null; then
    # Nord-aligned color scheme for eza
    export EZA_COLORS="\
di=1;34:\
ln=36:\
ex=1;32:\
fi=37:\
*.md=33:\
*.yml=33:\
*.yaml=33:\
*.toml=33:\
*.json=33:\
*.js=33:\
*.ts=33:\
*.py=33:\
*.rs=33:\
*.go=33:\
*.sh=32:\
*.bash=32:\
*.zsh=32:\
*.log=90:\
*.bak=90:\
*.tmp=90:\
*.swp=90:\
*.lock=90:\
*.git=90:\
ur=35:uw=35:ux=35:ue=35:\
gr=34:gw=34:gx=34:\
tr=36:tw=36:tx=36:\
sn=32:sb=32:\
da=36:\
uu=33:gu=33:\
hd=4;37"

    alias ls='eza --icons --group-directories-first'
    alias ll='eza -lgh --icons --git --header --group-directories-first'
    alias la='eza -lagh --icons --git --header --group-directories-first'
    alias l='eza -l --icons --group-directories-first'
    alias lt='eza --tree --icons --level=2 --group-directories-first'
    alias lta='eza --tree --icons --level=3 --group-directories-first -a'
    alias tree='eza --tree --icons --group-directories-first'
else
    alias ll='ls -la'
    alias la='ls -a'
    alias l='ls -l'
fi

# Common aliases
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias grep='grep --color=auto'
alias mkdir='mkdir -pv'
alias df='df -h'
alias du='du -h'

# fzf: fuzzy finder helpers
if command -v fzf &>/dev/null; then
    # fo: fuzzy-open file in editor (with bat preview)
    fo() {
        local file
        file=$(fzf --preview 'bat --color=always --style=numbers --line-range=:500 {} 2>/dev/null || head -500 {}')
        [ -n "$file" ] && ${EDITOR:-nano} "$file"
    }

    # fcd / fj: fuzzy-cd into directory
    fcd() {
        local dir
        if command -v fd &>/dev/null; then
            dir=$(fd --type d --hidden --follow --exclude .git 2>/dev/null | fzf --preview 'eza --tree --icons --level=1 {} 2>/dev/null || ls {}')
        else
            dir=$(find . -type d -not -path '*/\.*' 2>/dev/null | fzf --preview 'eza --tree --icons --level=1 {} 2>/dev/null || ls {}')
        fi
        [ -n "$dir" ] && cd "$dir"
    }
    alias fj='fcd'

    # gitbr: interactive git branch picker with preview
    gitbr() {
        local branch
        branch=$(git branch --all --sort=-committerdate --format='%(refname:short)' 2>/dev/null | \
            fzf --preview 'git log --oneline --graph --color=always -20 {}' \
                --preview-window=right:50% \
                --header='Select branch (Enter=checkout)')
        if [ -n "$branch" ]; then
            # Strip 'origin/' prefix for remote branches
            branch="${branch#origin/}"
            git checkout "$branch" 2>/dev/null || git checkout -b "$branch" "origin/$branch" 2>/dev/null
        fi
    }

    # gitlog: interactive commit browser with diff preview
    # Enter = show commit, Alt+Enter = paste hash to command line
    gitlog() {
        local out key hash
        out=$(git log --oneline --graph --color=always --all | \
            fzf --ansi --no-sort --reverse \
                --preview 'echo {} | grep -o "[a-f0-9]\{7,\}" | head -1 | xargs git show --color=always' \
                --preview-window=right:60% \
                --expect=alt-enter \
                --header='Enter=show | Alt+Enter=copy hash')
        key=$(echo "$out" | head -1)
        hash=$(echo "$out" | tail -1 | grep -o '[a-f0-9]\{7,\}' | head -1)
        [ -z "$hash" ] && return
        if [ "$key" = "alt-enter" ]; then
            # Paste hash into command line via readline
            if [ -n "$BASH_VERSION" ]; then
                bind '"\e[0n": "'"$hash"'"'; printf '\e[5n'
            elif [ -n "$ZSH_VERSION" ]; then
                print -z "$hash"
            fi
        else
            git show "$hash"
        fi
    }
fi

# Git shortcuts (oh-my-zsh compatible)
alias g='git'

# Status
alias gs='git status'
alias gss='git status --short'
alias gst='git status'

# Add
alias ga='git add'
alias gaa='git add --all'
alias gapa='git add --patch'

# Commit
alias gc='git commit --verbose'
alias gc!='git commit --verbose --amend'
alias gca='git commit --verbose --all'
alias gca!='git commit --verbose --all --amend'
alias gcam='git commit -a -m'
alias gcmsg='git commit --message'
alias gcn!='git commit --verbose --no-edit --amend'

# Branch
alias gb='git branch'
alias gba='git branch --all'
alias gbd='git branch --delete'
alias gbD='git branch --delete --force'

# Checkout / Switch
alias gco='git checkout'
alias gcb='git checkout -b'
alias gsw='git switch'
alias gswc='git switch --create'

# Push / Pull / Fetch
alias gp='git push'
alias gpf='git push --force-with-lease'
alias gpf!='git push --force'
alias gpsup='git push --set-upstream origin $(git branch --show-current)'
alias gl='git pull'
alias gf='git fetch'
alias gfo='git fetch origin'

# Diff
alias gd='git diff'
alias gds='git diff --staged'
alias gdca='git diff --cached'

# Merge
alias gm='git merge'
alias gma='git merge --abort'

# Rebase
alias grb='git rebase'
alias grbc='git rebase --continue'
alias grba='git rebase --abort'
alias grbs='git rebase --skip'

# gri: interactive rebase (defaults to last 2 commits)
gri() { git rebase -i "HEAD~${1:-2}"; }

# Reset / Restore
alias grh='git reset'
alias grhh='git reset --hard'
alias grs='git restore'
alias grss='git restore --staged'
alias gcl='git clean -fd'

# Stash
alias gsta='git stash push'
alias gstp='git stash pop'
alias gstaa='git stash apply'
alias gstd='git stash drop'
alias gstl='git stash list'

# Log
alias glog='git log --graph --decorate --format="%C(bold blue)%h%C(reset) %C(green)%ad%C(reset) %s%C(auto)%d%C(reset)" --date=short'
alias gloga='git log --oneline --graph --decorate --all'
alias glg='git log --stat'
alias gsh='git show'

# Cherry-pick
alias gcp='git cherry-pick'
alias gcpa='git cherry-pick --abort'
alias gcpc='git cherry-pick --continue'

# Remote
alias gr='git remote'
alias grv='git remote --verbose'

# Tags
alias gt='git tag'
alias gts='git tag --sign'

# gitgraph: pretty branch graph with colors and dates
alias gitgraph='git log --graph --all --decorate --oneline --color=always --format="%C(bold blue)%h%C(reset) %C(bold green)(%ar)%C(reset) %s %C(dim white)- %an%C(reset)%C(auto)%d%C(reset)"'

# Config version (delegates to epicli CLI)
alias version='epicli version'

# Safety nets
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'
