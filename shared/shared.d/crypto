#!/bin/sh
# Cryptography shortcuts: hashing, signatures, certs, passwords

# SHA-256 hash of file(s). Two args = compare hashes.
# Usage: sha <file> [file2]
sha() {
    if [ $# -eq 0 ]; then
        echo "Usage: sha <file> [file2]"
        echo "  sha myfile.iso          Print SHA-256"
        echo "  sha myfile.iso orig.iso Compare SHA-256 hashes"
        echo "  sha myfile.iso abc123...  Compare against known hash"
        return 0
    fi

    local _sha_cmd
    if command -v sha256sum &>/dev/null; then
        _sha_cmd="sha256sum"
    elif command -v shasum &>/dev/null; then
        _sha_cmd="shasum -a 256"
    else
        echo "No sha256 tool found (need sha256sum or shasum)"
        return 1
    fi

    if [ $# -eq 1 ]; then
        $_sha_cmd "$1"
        return
    fi

    # Two args: compare
    local hash1 hash2
    if [ -f "$1" ]; then
        hash1=$($_sha_cmd "$1" | awk '{print $1}')
    else
        hash1="$1"
    fi
    if [ -f "$2" ]; then
        hash2=$($_sha_cmd "$2" | awk '{print $1}')
    else
        hash2="$2"
    fi

    if [ "$hash1" = "$hash2" ]; then
        echo "MATCH: $hash1"
        return 0
    else
        echo "MISMATCH:"
        echo "  $hash1"
        echo "  $hash2"
        return 1
    fi
}

# Verify GPG signature (detached .sig/.asc or inline)
# Usage: checksig <file> [signature_file]
checksig() {
    if [ $# -eq 0 ]; then
        echo "Usage: checksig <file> [sigfile]"
        echo "  checksig doc.pdf                 Auto-find .sig or .asc"
        echo "  checksig doc.pdf doc.pdf.sig     Explicit signature file"
        echo "  checksig message.asc             Inline/clearsigned"
        return 0
    fi

    if ! command -v gpg &>/dev/null; then
        echo "gpg not found"
        return 1
    fi

    if [ $# -ge 2 ]; then
        gpg --verify "$2" "$1"
        return
    fi

    # Auto-detect signature file
    if [ -f "$1.sig" ]; then
        gpg --verify "$1.sig" "$1"
    elif [ -f "$1.asc" ]; then
        gpg --verify "$1.asc" "$1"
    else
        # Try as inline/clearsigned
        gpg --verify "$1"
    fi
}

# GPG detached-sign a file (creates .sig)
# Usage: signfile <file>
signfile() {
    if [ $# -eq 0 ]; then
        echo "Usage: signfile <file>"
        return 0
    fi

    if ! command -v gpg &>/dev/null; then
        echo "gpg not found"
        return 1
    fi

    gpg --detach-sign "$1" && echo "Created: $1.sig"
}

# Show fingerprint of GPG key, SSH key, or TLS certificate
# Usage: fingerprint <file|email|host:port>
fingerprint() {
    if [ $# -eq 0 ]; then
        echo "Usage: fingerprint <file|email|host>"
        echo "  fingerprint id_ed25519.pub     SSH public key"
        echo "  fingerprint cert.pem           TLS certificate"
        echo "  fingerprint user@example.com   GPG key by email"
        return 0
    fi

    local target="$1"

    # SSH key file
    if [ -f "$target" ] && head -1 "$target" 2>/dev/null | grep -q "^ssh-\|^ecdsa-"; then
        ssh-keygen -lf "$target"
        return
    fi

    # TLS cert file
    if [ -f "$target" ] && head -1 "$target" 2>/dev/null | grep -q "BEGIN CERTIFICATE"; then
        openssl x509 -in "$target" -noout -fingerprint -sha256
        return
    fi

    # GPG key by email/ID
    if command -v gpg &>/dev/null; then
        gpg --fingerprint "$target" 2>/dev/null && return
    fi

    echo "Could not detect key type for: $target"
    return 1
}

# Show TLS certificate details for a domain or .pem file
# Usage: certinfo <host|file> [port]
certinfo() {
    if [ $# -eq 0 ]; then
        echo "Usage: certinfo <host|file> [port]"
        echo "  certinfo example.com        HTTPS cert"
        echo "  certinfo example.com 8443   Custom port"
        echo "  certinfo cert.pem           Local cert file"
        return 0
    fi

    # Local cert file
    if [ -f "$1" ]; then
        openssl x509 -in "$1" -noout -subject -issuer -dates -ext subjectAltName 2>/dev/null
        return
    fi

    # Remote host
    local host="$1"
    local port="${2:-443}"
    echo | openssl s_client -servername "$host" -connect "$host:$port" 2>/dev/null \
        | openssl x509 -noout -subject -issuer -dates -ext subjectAltName 2>/dev/null
}

# Generate a secure random password
# Usage: pw [length]
pw() {
    local len="${1:-24}"
    if command -v openssl &>/dev/null; then
        openssl rand -base64 48 | tr -d '/+\n' | head -c "$len"
    else
        tr -dc 'A-Za-z0-9!@#$%&*' < /dev/urandom | head -c "$len"
    fi
    echo
}
